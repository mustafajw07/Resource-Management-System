<p-table #dt2 [value]="requisitions" dataKey="requisitionId" [rows]="10" [rowsPerPageOptions]="[10,25,50]"
    [loading]="loading" [expandedRowKeys]="expandedRows" [paginator]="true" [showGridlines]="false"
    sortField="ageingDays" [sortOrder]="-1">

    <!-- CAPTION -->
    <ng-template #caption>
        <div class="flex">
            <div class="mr-auto w-64">
                <div class="relative">
                    <i class="pi pi-search absolute right-3 top-1/2 -translate-y-1/2"></i>
                    <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')"
                        placeholder="Search keyword" class="pl-10 w-full" />
                </div>
            </div>
            <div class="ml-auto w-64">
                <div class="relative">
                    <p-button styleClass="!bg-[#307EF7] hover:!bg-[#0962EB] !border-[#307EF7] !text-white"
                        severity="contrast" label="Add New Request" icon="pi pi-plus" (click)="addRequisition()" />
                </div>
            </div>
        </div>
    </ng-template>

    <!-- HEADER -->
    <ng-template #header>
        <tr>
            <th></th>
            <th class="text-sm p-3!" *ngFor="let col of headers" [pSortableColumn]="col.field">
                {{ col.header }}
                <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
            <th></th>
        </tr>

        <!-- FILTER ROW -->
        <!-- <tr>
            <th></th>
            @for (col of headers; track col) {
            <th>
                <ng-container [ngSwitch]="col.filterType">

                    Text Field Filter
                    <p-columnFilter *ngSwitchCase="'text'" [field]="col.field" matchMode="contains" [showMenu]="false"
                        [showClearButton]="true" placeholder="Search {{ col.header }}">
                    </p-columnFilter>

                    Date Filters
                    <p-columnFilter *ngSwitchCase="'date'" [field]="col.field" matchMode="between" [showMenu]="false">

                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">

                            <p-datepicker (ngModelChange)="filter($event)" selectionMode="range" [readonlyInput]="true"
                                [showButtonBar]="true" placeholder="Select range">
                            </p-datepicker>

                        </ng-template>
                    </p-columnFilter>

                    Range
                    <p-columnFilter *ngSwitchCase="'range'" [field]="col.field" matchMode="between" [showMenu]="false">

                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">

                            <p-slider (onChange)="filter($event)" [range]="true" [min]="0" [max]="15" class="w-25">
                            </p-slider>

                        </ng-template>
                    </p-columnFilter>
                    <span *ngSwitchDefault></span>
                </ng-container>
            </th>
            }
            <th></th>
        </tr> -->
    </ng-template>

    <!-- BODY -->
    <ng-template #body let-row let-expanded="expanded">
        <tr [ngClass]="{
        'bg-red-50': row.ageingDays && row.ageingDays > 30,
        'bg-yellow-50': row.urgency === 'Immediate' && row.ageingDays! <= 30
      }">

            <!-- EXPAND -->
            <td>
                <p-button styleClass="text-blue-500! hover:text-blue-500!"
                    (onClick)="getRequisitionNotes(row.requisitionId)" type="button" pRipple [pRowToggler]="row"
                    [text]="true" severity="secondary" [rounded]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>

            <!-- COLUMNS -->
            <td *ngFor="let col of headers">
                <ng-container [ngSwitch]="col.field">

                    <!-- Dates -->
                    <span *ngSwitchCase="'requisitionDate'">
                        {{ row.requisitionDate | date:'mediumDate' }}
                    </span>

                    <span *ngSwitchCase="'tentativeOnboardingDate'"
                        [ngClass]="onboardingClass(row.tentativeOnboardingDate)">
                        {{ row.tentativeOnboardingDate | date:'mediumDate' }}
                    </span>

                    <!-- Urgency -->
                    <p *ngSwitchCase="'urgency'" [ngClass]="urgencyClass(getFieldValue(row, col.field))">
                        {{getFieldValue(row, col.field)}}</p>

                    <!-- Ageing -->
                    <span *ngSwitchCase="'ageingDays'" [ngClass]="ageingClass(row.ageingDays)">
                        {{ row.ageingDays }} days
                        <i *ngIf="row.ageingDays! > 30" class="pi pi-exclamation-triangle ml-1"></i>
                    </span>

                    <span *ngSwitchCase="'projectName'" pTooltip="{{ row.projectName }}" tooltipPosition="top">
                        {{ row.projectName | slice:0:15 }}{{ row.projectName?.length! > 15 ? 'â€¦' : '' }}
                    </span>

                    <!-- Default -->
                    <span *ngSwitchDefault>
                        {{ getFieldValue(row, col.field) }}
                    </span>

                </ng-container>
            </td>

            <!-- ACTION -->
            <td>
                <button severity="contrast" pButton icon="pi pi-pencil"
                    class="p-button-text p-button-text p-button-rounded text-blue-500! hover:text-blue-500!"
                    (click)="editRequisition(row)">
                </button>
            </td>
        </tr>
    </ng-template>

    <ng-template #expandedrow let-row>
        <tr>
            <td [attr.colspan]="headers.length + 2">
                <div class="p-4 bg-gray-50 rounded-md">

                    <!-- TOP INFO GRID -->
                    <div class="grid grid-cols-1 gap-4 mb-4 text-md">

                        <p>
                            <i class="pi pi-send mr-2 text-gray-500"></i>
                            <strong>Fulfillment Medium:</strong>
                            {{ row.fulfillmentMedium || 'N/A' }}
                        </p>

                        <p class="flex items-center gap-2">
                            <i class="pi pi-flag mr-1 text-gray-500"></i>
                            <strong>Requisition Status:</strong>
                            {{row.requisitionStatus || 'N/A'}}
                        </p>

                        <p>
                            <i class="pi pi-calendar mr-2 text-gray-500"></i>
                            <strong>Tentative Onboarding:</strong>
                            <span [ngClass]="onboardingClass(row.tentativeOnboardingDate)">
                                {{ row.tentativeOnboardingDate
                                ? (row.tentativeOnboardingDate | date:'mediumDate')
                                : 'N/A' }}
                            </span>
                        </p>
                    </div>

                    <!-- NOTES -->
                    <div class="border-t pt-3">
                        <p class="font-semibold mb-1">
                            <i class="pi pi-file-edit mr-2 text-gray-500"></i>
                            Notes:
                        </p>

                        <ng-container *ngIf="notesMap.get(row.requisitionId) as list;">
                            <div class="space-y-3">
                                <div *ngFor="let n of list" class="text-sm text-gray-700">
                                    <div style="white-space: pre-wrap;">{{ n.noteText }}</div>
                                    <div class="text-md text-gray-500 mt-1">
                                        <i class="pi pi-users mr-2 text-gray-500"></i>
                                        {{ n.createdBy }}
                                        <i class="pi pi-calendar mr-2 text-gray-500"></i>
                                        {{ n.createdAt | date:'medium' }}
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="10">No Requisitions found.</td>
        </tr>
    </ng-template>
</p-table>

@if(visible){
<p-dialog [header]="popupHeader" [modal]="true" [(visible)]="visible" [style]="{ width: '45%' }">
    <app-requisition-form 
        (submitted)="handleFormSubmitted($event)" (cancel)="visible = false"></app-requisition-form>
</p-dialog>
}