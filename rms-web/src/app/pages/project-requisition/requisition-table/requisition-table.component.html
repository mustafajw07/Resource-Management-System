<p-table #dt2 [value]="requisitions" dataKey="requisitionId" [rows]="10" [rowsPerPageOptions]="[10,25,50]"
    [loading]="loading" [expandedRowKeys]="expandedRows" [paginator]="true" [showGridlines]="false"
    sortField="ageingDays" [sortOrder]="-1">

    <!-- CAPTION -->
    <ng-template #caption>
        <div class="flex">
            <div class="mr-auto w-64">
                <div class="relative">
                    <i class="pi pi-search absolute right-3 top-1/2 -translate-y-1/2"></i>
                    <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')"
                        placeholder="Search keyword" class="pl-10 w-full" />
                </div>
            </div>
            <div class="ml-auto w-64">
                <div class="relative">
                    <p-button styleClass="!bg-[#307EF7] hover:!bg-[#0962EB] !border-[#307EF7] !text-white"
                        severity="contrast" label="Add New Request" icon="pi pi-plus" (click)="addRequisition()" />
                </div>
            </div>
        </div>
    </ng-template>

    <!-- HEADER -->
    <ng-template #header>
        <tr>
            <th></th>
            <th class="text-sm p-3!" *ngFor="let col of headers" [pSortableColumn]="col.field">
                {{ col.header }}
                <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
            <th></th>
        </tr>

        <!-- FILTER ROW -->
        <!-- <tr>
            <th></th>
            @for (col of headers; track col) {
            <th>
                <ng-container [ngSwitch]="col.filterType">

                    Text Field Filter
                    <p-columnFilter *ngSwitchCase="'text'" [field]="col.field" matchMode="contains" [showMenu]="false"
                        [showClearButton]="true" placeholder="Search {{ col.header }}">
                    </p-columnFilter>

                    Date Filters
                    <p-columnFilter *ngSwitchCase="'date'" [field]="col.field" matchMode="between" [showMenu]="false">

                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">

                            <p-datepicker (ngModelChange)="filter($event)" selectionMode="range" [readonlyInput]="true"
                                [showButtonBar]="true" placeholder="Select range">
                            </p-datepicker>

                        </ng-template>
                    </p-columnFilter>

                    Range
                    <p-columnFilter *ngSwitchCase="'range'" [field]="col.field" matchMode="between" [showMenu]="false">

                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">

                            <p-slider (onChange)="filter($event)" [range]="true" [min]="0" [max]="15" class="w-25">
                            </p-slider>

                        </ng-template>
                    </p-columnFilter>
                    <span *ngSwitchDefault></span>
                </ng-container>
            </th>
            }
            <th></th>
        </tr> -->
    </ng-template>

    <!-- BODY -->
    <ng-template #body let-row let-expanded="expanded">
        <tr [ngClass]="{
        'bg-red-50': row.ageingDays && row.ageingDays > 30,
        'bg-yellow-50': row.urgency === 'Immediate' && row.ageingDays! <= 30
      }">

            <!-- DETAIL -->
            <td>
            </td>

            <!-- COLUMNS -->
            <td *ngFor="let col of headers">
                <ng-container [ngSwitch]="col.field">

                    <!-- Dates -->
                    <span *ngSwitchCase="'requisitionDate'">
                        {{ row.requisitionDate | date:'mediumDate' }}
                    </span>

                    <span *ngSwitchCase="'tentativeOnboardingDate'"
                        [ngClass]="onboardingClass(row.tentativeOnboardingDate)">
                        {{ row.tentativeOnboardingDate | date:'mediumDate' }}
                    </span>

                    <!-- Urgency -->
                    <p *ngSwitchCase="'urgency'" [ngClass]="urgencyClass(getFieldValue(row, col.field))">
                        {{getFieldValue(row, col.field)}}</p>

                    <!-- Ageing -->
                    <span *ngSwitchCase="'ageingDays'" [ngClass]="ageingClass(row.ageingDays)">
                        {{ row.ageingDays }} days
                        <i *ngIf="row.ageingDays! > 30" class="pi pi-exclamation-triangle ml-1"></i>
                    </span>

                    <span *ngSwitchCase="'projectName'" pTooltip="{{ row.projectName }}" tooltipPosition="top">
                        {{ row.projectName | slice:0:15 }}{{ row.projectName?.length! > 15 ? 'â€¦' : '' }}
                    </span>

                    <!-- Default -->
                    <span *ngSwitchDefault>
                        {{ getFieldValue(row, col.field) }}
                    </span>

                </ng-container>
            </td>
            <td>
                <p-button [routerLink]="['/project-requisition/details', row.requisitionId]" styleClass="text-blue-500! hover:text-blue-500!" type="button" 
                    [text]="true" severity="secondary" [rounded]="true">
                     <i  class="pi pi-eye"></i></p-button>
            </td>
        </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="10">No Requisitions found.</td>
        </tr>
    </ng-template>
</p-table>

@if(visible){
<p-dialog [header]="popupHeader" [modal]="true" [(visible)]="visible" [style]="{ width: '45%' }">
    <app-requisition-form 
    (submitted)="handleFormSubmitted($event)" (cancel)="visible = false"></app-requisition-form>
</p-dialog>
}