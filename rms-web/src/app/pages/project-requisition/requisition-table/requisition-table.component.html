<p-table #dt2 [value]="requisitions" dataKey="requisitionId" [rows]="10" [rowsPerPageOptions]="[10,25,50]"
    [loading]="loading" [paginator]="true" [globalFilterFields]="globalFilterFields" [showGridlines]="false"
    [expandedRowKeys]="expandedRows">

    <ng-template #caption>
        <div class="flex">
            <div class="mr-auto w-64">
                <div class="relative">
                    <i class="pi pi-search absolute right-3 top-1/2 -translate-y-1/2"></i>
                    <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')"
                        placeholder="Search keyword" class="pl-10 w-full" />
                </div>
            </div>
            <div class="ml-auto w-64">
                <div class="relative">
                    <p-button severity="contrast" label="Add New Request" icon="pi pi-plus"
                        (click)="addRequisition()" />
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #header>
        <tr>
            <th></th>
            <!-- [pSortableColumn]="col.field" -->
            <th class="md:px-2.5! md:py-3!" *ngFor="let col of headers">
                <div class="flex items-center justify-between md:text-nowrap md:gap-2 md:p-0 md:text-sm">
                    <span>{{ col.header }}</span>
                    <!-- <p-sortIcon [field]="col.field"></p-sortIcon> -->
                </div>
            </th>
            <th></th>
        </tr>
    </ng-template>

    <ng-template #body let-row let-expanded="expanded">
        <tr>
            <td class="text-center align-middle md:p-0!">
                <p-button type="button" pRipple [pRowToggler]="row" [text]="true" severity="secondary" [rounded]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
            </td>
            <td *ngFor="let col of headers">
                <ng-container [ngSwitch]="col.field">
                    <span *ngSwitchCase="'requisitionDate'">{{ getFieldValue(row, col.field) | date:'mediumDate' }}</span>
                    <span *ngSwitchCase="'tentativeOnboardingDate'">{{ getFieldValue(row, col.field) | date:'mediumDate' }}</span>
                    <p *ngSwitchCase="'urgency'" [ngClass]="urgencyClass(getFieldValue(row, col.field))">{{getFieldValue(row, col.field)}}</p>
                    <span *ngSwitchDefault>{{ getFieldValue(row, col.field) }}</span>
                </ng-container>
            </td>
            <td class="text-center align-middle md:p-0!">
                <button pButton severity="contrast" type="button" class="p-button-text p-button-rounded"
                    (click)="editRequisition()" icon="pi pi-pencil">
                </button>
            </td>
        </tr>
    </ng-template>

    <ng-template #expandedrow let-row>
        <tr>
            <td [attr.colspan]="headers.length + 2">
                <div class="p-4 bg-gray-50">
                    <p class="mb-2"><strong>Capability Area:</strong> {{ row.capabilityArea || 'N/A' }}</p>
                    <p class="mb-2"><strong>Fulfillment Medium:</strong> {{ row.fulfillmentMedium || 'N/A' }}</p>
                    <p class="mb-2"><strong>Requisition Status:</strong> {{ row.requisitionStatus || 'N/A' }}</p>
                    <p class="mb-2"><strong>FTE Total Allocation:</strong> {{ row.fteTotalAllocation ?? 'N/A' }}</p>
                    <p class="mb-2"><strong>FTE Fulfilled Allocation:</strong> {{ row.fulfilledAllocation ?? 'N/A' }}
                    </p>
                    <p class="mb-2"><strong>Tentative Onboarding:</strong> {{ row.tentativeOnboardingDate ?
                        (row.tentativeOnboardingDate | date:'mediumDate') : 'N/A' }}</p>
                    <p class="mb-0"><strong>Notes:</strong> {{ row.notes ? row.notes : 'N/A' }}</p>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template #emptymessage>
        <tr>
            <td colspan="10">No Requisitions found.</td>
        </tr>
    </ng-template>
</p-table>

@if(visible){
<p-dialog [header]="popupHeader" [modal]="true" [(visible)]="visible" [style]="{ width: '70%' }">
    <app-requisition-form (submitted)="handleFormSubmitted($event)" (cancel)="visible = false"></app-requisition-form>
</p-dialog>
}